name: CI

on: [push]

jobs:
  foundry-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master
        with:
          fetch-depth: 0
          submodules: recursive
      - uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly
      - name: Install forge-std
        run: |
          forge install foundry-rs/forge-std --no-commit
          forge remappings > remappings.txt
      - name: Run non-Kontrol tests
        run: |
          forge test --no-match-path "src/test/kontrol/*" -vvv
      - name: Run snapshot without Kontrol tests
        run: forge snapshot --no-match-path "src/test/kontrol/*"

  formal-verification:
    runs-on: ubuntu-latest
    needs: foundry-test
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup Environment Variables
        run: |
          echo "K_ROOT=$GITHUB_WORKSPACE/kframework" >> $GITHUB_ENV
          echo "KEVM_ROOT=$GITHUB_WORKSPACE/evm" >> $GITHUB_ENV
          echo "PATH=$GITHUB_WORKSPACE/kframework/k-distribution/target/release/k/bin:$GITHUB_WORKSPACE/evm/bin:$PATH" >> $GITHUB_ENV

      - name: Download and Extract K Framework
        env:
          REPOSITORY_TOKEN: ${{ secrets.REPOSITORY_TOKEN }}
        run: |
          curl -H "Authorization: token $REPOSITORY_TOKEN" \
               -L -o kframework.tar.gz \
               https://github.com/runtimeverification/k/releases/download/v7.1.170/kframework-7.1.170-src.tar.gz
          
          mkdir -p "$K_ROOT"
          tar -xzf kframework.tar.gz -C "$K_ROOT" --strip-components=1
          
          echo "K Framework contents:"
          ls -la "$K_ROOT"

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: 1.4.0
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Install KEVM
        env:
          REPOSITORY_TOKEN: ${{ secrets.REPOSITORY_TOKEN }}
        run: |
          curl -H "Authorization: token $REPOSITORY_TOKEN" \
               -L -o evm.tar.gz \
               https://github.com/runtimeverification/evm-semantics/archive/refs/tags/v1.0.753.tar.gz
          
          mkdir -p "$KEVM_ROOT"
          tar -xzf evm.tar.gz -C "$KEVM_ROOT" --strip-components=1
          
          cd "$KEVM_ROOT"
          make deps
          make build
          make test

      - name: Setup K Framework
        run: |
          cd "$K_ROOT"
          
          # Build K Framework
          mvn package -DskipTests
          
          # Setup paths
          K_BIN="$K_ROOT/k-distribution/target/release/k/bin"
          K_LIB="$K_ROOT/k-distribution/target/release/k/lib/kframework"
          
          # Verify directory structure
          echo "K Framework directory structure:"
          ls -R "$K_BIN"
          ls -R "$K_LIB"
          
          # Export paths
          echo "K_BIN=$K_BIN" >> $GITHUB_ENV
          echo "K_LIB=$K_LIB" >> $GITHUB_ENV
          echo "PATH=$K_BIN:$PATH" >> $GITHUB_ENV

      - name: Configure KRUN
        run: |
          KRUN_SCRIPT="$K_BIN/krun"
          
          if [ ! -f "$KRUN_SCRIPT" ]; then
            echo "Error: krun script not found at $KRUN_SCRIPT"
            exit 1
          fi
          
          # Backup original script
          cp "$KRUN_SCRIPT" "${KRUN_SCRIPT}.backup"
          
          # Update paths in krun script
          sed -i "s|source \"\$dir/\.\./lib/kframework/k-util\.sh\"|source \"$K_LIB/k-util.sh\"|g" "$KRUN_SCRIPT"
          
          echo "Modified krun script:"
          head -n 10 "$KRUN_SCRIPT"
          
          # Test krun
          "$KRUN_SCRIPT" --version

      - name: Run Formal Verification
        run: |
          mkdir -p verification-results
          
          # Initialize counter for verified specs
          verified_count=0
          
          for spec in src/test/kontrol/*.k; do
            if [ -f "$spec" ]; then
              echo "Verifying $spec..."
              
              if "$K_BIN/krun" \
                 --directory src/test/kontrol \
                 --debug \
                 --output-file "verification-results/$(basename "$spec" .k).out" \
                 "$spec"; then
                echo "✓ Verification successful for $spec"
                ((verified_count++))
              else
                echo "✗ Verification failed for $spec"
                exit 1
              fi
            fi
          done
          
          if [ $verified_count -eq 0 ]; then
            echo "No specification files found to verify"
            exit 1
          else
            echo "Successfully verified $verified_count specification(s)"
          fi

      - name: Upload Verification Results
        uses: actions/upload-artifact@v3
        with:
          name: verification-results
          path: verification-results/
          if-no-files-found: error
          retention-days: 30